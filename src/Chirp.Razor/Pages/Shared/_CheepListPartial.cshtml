@using Chirp.Core.Classes
@using Chirp.Core.Interfaces
@using System.Text;
@using System.Security.Cryptography;
@model (List<CheepDTO> Cheeps, Range CheepRange, int PageNumber, int TotalPages, Author? userAuthor, List<Author> followedAuthors)
@inject ICheepService CheepService
@{
    var nextPage = Model.PageNumber < Model.TotalPages ? Model.PageNumber + 1 : Model.TotalPages;
    var lastPage = Model.PageNumber > 1 ? Model.PageNumber - 1 : 1;
    var isFirstPage = Model.PageNumber == 1;
    var isLastPage = Model.PageNumber == Model.TotalPages;
}
@functions {
    public static string sha256_hash(string value)
    {
        using (SHA256 hash = SHA256.Create())
        {
            Encoding enc = Encoding.UTF8;
            Byte[] result = hash.ComputeHash(enc.GetBytes(value));

            var sb = new StringBuilder();
            foreach (Byte b in result)
                sb.Append(b.ToString("x2"));

            return sb.ToString();
        }
    }

    public static string timeSince(DateTime time)
    {
        TimeSpan span = DateTime.Now - time;
        if (span.TotalDays > 7)
        {
            return time.ToString("MMM d" + (time.Year != DateTime.Now.Year ? ", yyyy" : ""));
        }
        else if (span.TotalDays > 1)
        {
            return $"{(int)span.TotalDays} days ago";
        }
        else if (span.TotalHours > 1)
        {
            return $"{(int)span.TotalHours} hours ago";
        }
        else if (span.TotalMinutes > 1)
        {
            return $"{(int)span.TotalMinutes} minutes ago";
        }
        else
        {
            return "Just now";
        }
    }
}
<style>
    .holder {
        --is-first-page:
            @isFirstPage
        ;
        --is-last-page:
            @isLastPage
        ;
    }
</style>




@if (Model.Cheeps.Any())
{
    <ul id="messagelist" class="cheeps">
        @foreach (var cheep in Model.Cheeps)
        {
            <li>
                <div class="info">
                @if (cheep.Author.Email != null)
                {
                    <img class="icon" src="https://gravatar.com/avatar/@sha256_hash(cheep.Author.Email)" alt="Icon1" />
                } else{
                    <img class="icon" src="https://gravatar.com/avatar/?d=identicon" alt="Icon1" />
                }
                <div class="details">
                <strong>
                    <a href="/@cheep.Author.UserName">@cheep.Author.UserName</a>
                    <span
                    title="@cheep.TimeStamp.ToString("yyyy-MM-dd HH:mm:ss")"> · @timeSince(cheep.TimeStamp)</span>
                </strong>
                <p>
                    @cheep.Text
                </p>
                </div>
                </div>
                @if (User.Identity != null)
                {
                    @if (User.Identity.IsAuthenticated && User.Identity.Name == cheep.Author.UserName)
                    {
                        <div class="cheep-actions">
                            <div class="dropdown">
                                <button class="dropdown-toggle" onclick="toggleDropdown(this)">⋯</button>
                                <div class="dropdown-menu">
                                    <form method="post" asp-page-handler="DeleteCheep">
                                        <input type="hidden" name="cheepId" value="@cheep.CheepId" />
                                        <input type="hidden" name="page" value="@Model.PageNumber" />
                                        <button type="submit">Delete Cheep</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    }
                }
                <div class="comments-section">
                    <button class="comment-toggle" onclick="toggleComments(@cheep.CheepId)">Show Comments</button>
                    <div id="comments-@cheep.CheepId" class="comments-container" style="display: none;">
                        <div class="comments-list">
                            @foreach (var comment in CheepService.GetCommentsForCheep(cheep.CheepId))
                            {
                                <div class="comment">
                                    <div class="comment-header">
                                        <strong><a href="/@comment.Author.UserName">@comment.Author.UserName</a></strong>
                                        <span title="@comment.TimeStamp.ToString("yyyy-MM-dd HH:mm:ss")">
                                            · @timeSince(comment.TimeStamp)
                                        </span>
                                    </div>
                                    <p>@comment.Text</p>
                                    @if (User.Identity?.Name == comment.Author.UserName)
                                    {
                                        <form method="post" asp-page-handler="DeleteComment">
                                            <input type="hidden" name="commentId" value="@comment.CommentId" />
                                            <input type="hidden" name="page" value="@Model.PageNumber" />
                                            <button type="submit" class="delete-comment">Delete</button>
                                        </form>
                                    }
                                </div>
                            }
                        </div>
                        @if (User.Identity?.IsAuthenticated == true)
                        {
                            <form method="post" asp-page-handler="AddComment" class="comment-form">
                                <input type="hidden" name="cheepId" value="@cheep.CheepId" />
                                <input type="text" name="commentText" maxlength="160" placeholder="Write a comment..." required />
                                <button type="submit">Comment</button>
                            </form>
                        }
                    </div>
                </div>
            </li>
        }
    </ul>
}
else
{
    <em>There are no cheeps so far.</em>
}
<div class="pager">
    <button onclick="window.location.href='?page=@lastPage'" disabled="@isFirstPage" class="prev">←</button>
    <span>Page @Model.PageNumber / @Model.TotalPages</span>
    <button onclick="window.location.href='?page=@nextPage'" disabled="@isLastPage" class="next">→</button>
</div>

@* @section Scripts { *@
    <script>
        function toggleDropdown(button) {
            event.preventDefault();
            const menu = button.nextElementSibling;
            menu.classList.toggle('show');
        }

        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-toggle')) {
                const dropdowns = document.getElementsByClassName('dropdown-menu');
                for (const dropdown of dropdowns) {
                    if (dropdown.classList.contains('show')) {
                        dropdown.classList.remove('show');
                    }
                }
            }
        }

        function toggleComments(cheepId) {
            const commentsContainer = document.getElementById(`comments-${cheepId}`);
            const isHidden = commentsContainer.style.display === 'none';
            commentsContainer.style.display = isHidden ? 'block' : 'none';
            event.target.textContent = isHidden ? 'Hide Comments' : 'Show Comments';
        }
    </script>
@* } *@